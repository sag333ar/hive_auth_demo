<!DOCTYPE html>
<html>
  <head>
    <script
      src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
      integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
      crossorigin="anonymous"
    ></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.1.0/uuidv4.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"
      integrity="sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      // HAS variables
      const HAS_SERVER = "wss://hive-auth.arcange.eu";
      const HAS_APP_DATA = {
        name: "has-demo-client-html",
        description: "Demo - HiveAuth from html",
      };
      const app_key = uuidv4();
      let username;
      let token;
      let expire;
      let auth_key;
      let auth_uuid;
      // Initialize WebSocket
      let ws = undefined;
      if ("WebSocket" in window) {
        // The browser support Websocket
        ws = new WebSocket(HAS_SERVER);
        ws.onopen = function () {
          // Web Socket is connected
          console.log("WebSocket connected");
        };
        ws.onmessage = function (event) {
          //const msg = JSON.parse(evt.data)
          console.log(event.data);
          const message =
            typeof event.data == "string" ? JSON.parse(event.data) : event.data;
          // Process HAS <-> PKSA protocol
          if (message.cmd) {
            switch (message.cmd) {
              case "auth_wait":
                // Update QRCode
                const json = JSON.stringify({
                  account: username,
                  uuid: message.uuid,
                  key: auth_key,
                  host: HAS_SERVER,
                });
                const URI = `has://auth_req/${btoa(json)}`;
                console.log("done");
                console.log(`has auth is - ${URI}`);
                break;
              case "auth_ack":
                try {
                  // Try to decrypt and parse payload data
                  message.data = JSON.parse(
                    CryptoJS.AES.decrypt(message.data, auth_key).toString(
                      CryptoJS.enc.Utf8
                    )
                  );
                  token = message.data.token;
                  expire = message.data.expire;
                } catch (e) {
                  // Decryption failed - ignore message
                  console.error("decryption failed", e.message);
                  click_logout();
                }

                break;
              case "auth_nack":
                click_logout();
                break;
              case "sign_wait":
                alert(`transaction ${message.uuid} is waiting for approval`);
                break;
              case "sign_ack":
                alert(`transaction ${message.uuid} approved`);
                break;
              case "sign_nack":
                alert(`transaction ${message.uuid} has been declined`);
                break;
              case "sign_err":
                alert(`transaction ${message.uuid} failed: ${message.error}`);
                break;
            }
          }
        };
        // websocket is closed.
        ws.onclose = function () {
          alert("WebSocket closed. Please reload the page...");
        };
      } else {
        alert("The browser doesn't support WebSocket");
      }

      function click_login(uname) {
        username = uname.toLowerCase();
        const auth_data = {
          app: HAS_APP_DATA,
          token: undefined,
          challenge: undefined,
        };

        auth_key = uuidv4();
        const data = CryptoJS.AES.encrypt(
          JSON.stringify(auth_data),
          auth_key
        ).toString();
        const payload = { cmd: "auth_req", account: username, data: data };
        ws.send(JSON.stringify(payload));
      }
      function click_logout() {
        username = undefined;
        token = undefined;
        expire = undefined;
      }

      function click_posting() {
        const op = [
          "custom_json",
          {
            id: "test",
            json: '{"action":"test HAS posting"}',
            required_auths: [],
            required_posting_auths: [username],
          },
        ];
        const sign_data = {
          key_type: "posting",
          ops: [op],
          broadcast: true,
        };
        const data = CryptoJS.AES.encrypt(
          JSON.stringify(sign_data),
          auth_key
        ).toString();
        const payload = {
          cmd: "sign_req",
          account: username,
          token: token,
          data: data,
        };
        ws.send(JSON.stringify(payload));
      }
      function click_active() {
        const op = [
          "transfer",
          {
            from: username,
            to: "arcange",
            amount: "0.001 HIVE",
            memo: "test HAS active",
          },
        ];
        const sign_data = {
          key_type: "active",
          ops: [op],
          broadcast: true,
        };
        const data = CryptoJS.AES.encrypt(
          JSON.stringify(sign_data),
          auth_key
        ).toString();
        const payload = {
          cmd: "sign_req",
          account: username,
          token: token,
          data: data,
        };
        ws.send(JSON.stringify(payload));
      }
    </script>
  </body>
</html>
